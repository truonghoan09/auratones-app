@use "./mixins" as *;

/* ========== BIẾN SIZE ========== */
:root {
  --modal-min: 0;
  --modal-min-compact: 0;

  --cell-min: 6.25rem;

  --select-min: 6rem;
  --select-min-root: 5.5rem;
  --select-min-bass: 5.5rem;

  --toggle-on-color: var(--accent-color);
  --toggle-off-color: color-mix(in srgb, var(--text-color) 70%, var(--card-background) 30%);
  --toggle-hover-color: color-mix(in srgb, var(--accent-color) 80%, var(--text-color) 20%);
}

/* ========== OVERLAY / MODAL CENTER ========== */
.chord-modal {
  position: fixed;       /* bật lại để modal overlay đúng */
  display: grid;         /* bật lại để place-items hoạt động */
  place-items: center;
}

.chord-modal .backdrop { position: absolute; inset: 0; }

/* ========== PANEL / LAYOUT ========== */
.panel.chord-panel {
  display: inline-grid !important;     /* không chiếm full width như block */
  /* ↓↓↓ ép cặp physical & logical để đè mọi rule width:100% ở .panel gốc ↓↓↓ */
  inline-size: max-content !important;
  width: max-content !important;
  max-inline-size: 92vw;
  max-width: 92vw;

  block-size: max-content !important;
  height: max-content !important;
  max-block-size: 90vh;
  max-height: 90vh;

  align-content: start;                 /* tránh stretch theo trục dọc */
}

.card {
  padding: 0.625rem;
  background: var(--card-background);
  border-radius: 0.75rem;
  border: 0.0625rem solid color-mix(in srgb, var(--text-color) 10%, transparent);
}

.editor-body.editor-split{
  display: flex;
  justify-content: center;
  align-items: center;
  height: fit-content;
  width: fit-content;
}

.editor-controls {
  .lbl { font-weight: 700; }
}

/* HÀNG TRÊN */
.ctrl-row-main {
  width: auto !important;  /* ngừng ép full width */
  display: grid;
  align-items: center;
  column-gap: 0.75rem;
  row-gap: 0.5rem;

  grid-template-columns:
    minmax(0, 0.9fr)
    minmax(max-content, 1fr)
    minmax(0, 2fr);

  .has-slash & {
    grid-template-columns:
      minmax(0, 0.9fr)
      minmax(max-content, 1fr)
      minmax(0, 0.9fr)
      minmax(0, 1.6fr);
  }

  .ctrl-cell {
    min-inline-size: 0; min-width: 0;
    display: grid; grid-template-rows: auto auto; row-gap: 0.4rem;
  }

  .cell-root select { min-inline-size: var(--select-min-root); }
  .cell-bass select { min-inline-size: var(--select-min-bass); }

  .cell-recipe select { min-inline-size: max-content; inline-size: 100%; }

  .cell-preview {
    min-inline-size: 0; min-width: 0; justify-self: stretch; text-align: center;
    .preview-code {
      display: block; inline-size: 100%; max-inline-size: 100%; box-sizing: border-box;
      padding: 0.375rem 0.625rem; border-radius: 0.5rem;
      border: 0.0625rem solid color-mix(in srgb, var(--text-color) 16%, transparent);
      background: color-mix(in srgb, var(--card-background) 96%, var(--background-color) 4%);
      font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
  }
}

/* HÀNG DƯỚI: toggle */
.ctrl-row-toggles {
  display: grid; grid-template-columns: 1fr 1fr; align-items: center; column-gap: 0.75rem; row-gap: 0.5rem;
  .ctrl-cell { min-width: 8rem; min-inline-size: 0; display: flex; align-items: center; justify-content: center; }
  .cell-toggle-voicing { justify-content: flex-end; }
}

/* Select chung */
.editor-controls select { @include select-base(1.875rem, 100%, 2rem, 0.75rem); inline-size: 100%; min-inline-size: var(--select-min); }
.editor-controls.card { overflow: hidden; }

/* Toggle theme */
.toggle {
  display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.5rem; border: none; background: transparent;
  color: var(--toggle-off-color); cursor: pointer; line-height: 1; transition: color 120ms ease, transform 60ms ease;
  svg { inline-size: 1rem; block-size: 1rem; display: block; }
  svg path { fill: currentColor; }
  &:hover { transform: translateY(-0.03125rem); color: var(--toggle-hover-color); }
  &:focus-visible { outline: 0.12rem solid color-mix(in srgb, var(--accent-color) 60%, transparent); outline-offset: 0.12rem; border-radius: 0.5rem; }
  &.is-on { color: var(--toggle-on-color); }
}

@media (max-width: 68rem) {
  .ctrl-row-main { row-gap: 1rem; .ctrl-cell { min-width: 0; } }
  .ctrl-row-toggles { grid-template-columns: 1fr; .cell-toggle-voicing { justify-content: flex-start; } }
}

/* FOOTER */
.editor-footer {
  display: flex; justify-content: space-between; align-items: center; gap: 0.75rem;
  > div:last-child { display: inline-flex; align-items: center; gap: 0.5rem; }
  .btn-primary, .btn-secondary { font-size: 0.875rem; line-height: 1.1; display: inline-flex; align-items: center; justify-content: center; }
}
.editor-footer-note { opacity: .78; }

.btn-primary {
  padding: 0.5rem 0.875rem; border-radius: 999rem; border: none; cursor: pointer;
  font-weight: 700; background: var(--accent-color, #3b7ad1); color: var(--text-color) !important;
  box-shadow: 0 0.375rem 1.125rem rgba(var(--accent-color-rgb, 59, 122, 209), 0.28);
  transition: transform 120ms ease, box-shadow 120ms ease;
  &:hover { transform: translateY(-0.0625rem); box-shadow: 0 0.625rem 1.375rem rgba(var(--accent-color-rgb, 59, 122, 209), 0.36); }
  &:disabled { opacity: .6; pointer-events: none; color: var(--text-color) !important; }
}
.btn-secondary {
  padding: 0.5rem 0.875rem; border-radius: 999rem; border: 0.0625rem solid color-mix(in srgb, var(--text-color) 20%, transparent);
  background: var(--card-background); color: var(--text-color) !important; cursor: pointer; transition: background 120ms ease;
  &:hover { background: color-mix(in srgb, var(--card-background) 92%, var(--background-color) 8%); }
  &:disabled { opacity: .6; pointer-events: none; }
}

/* STATE */
.editor-controls.invalid { outline: 0.125rem solid #f44336; outline-offset: 0.25rem; border-radius: 0.5rem; }
.select-invalid { @include control-invalid(); }

/* COMPACT: giữ nguyên co theo nội dung */
.panel.chord-panel.compact { inline-size: max-content; max-inline-size: 92vw; max-block-size: 90vh; overflow: visible; justify-self: center; align-self: center; }
.panel.chord-panel.compact .editor-controls.card { inline-size: max-content; max-inline-size: 92vw; }
.panel.chord-panel.compact .ctrl-row-main { grid-template-columns: max-content max-content max-content; column-gap: 0.75rem; }
.panel.chord-panel.compact.has-slash .ctrl-row-main { grid-template-columns: max-content max-content max-content max-content; }
.panel.chord-panel.compact .editor-controls select { inline-size: auto; width: auto; min-inline-size: auto; }
.panel.chord-panel.compact .cell-recipe select { min-inline-size: max-content; }
.panel.chord-panel.compact .cell-preview { justify-self: stretch; text-align: center; }
.panel.chord-panel.compact .cell-preview .preview-code { display: block; inline-size: 100%; max-inline-size: none; }

/* === Loading badge in header title === */
.panel.chord-panel header .title {
  display: flex;
  align-items: center;
  gap: 0.5rem;

  /* util nhỏ nếu chưa có */
  .ml-8 { margin-left: 0.5rem; }

  .small.muted {
    /* badge */
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.18rem 0.6rem;
    border-radius: 999rem;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: color-mix(in srgb, var(--text-color) 86%, transparent);
    background: color-mix(in srgb, var(--card-background) 86%, var(--background-color) 14%);
    border: 0.0625rem solid color-mix(in srgb, var(--text-color) 12%, transparent);

    /* spinner */
    &::before {
      content: "";
      inline-size: 0.85rem;
      block-size: 0.85rem;
      border-radius: 50%;
      border: 0.14rem solid color-mix(in srgb, var(--text-color) 38%, transparent);
      border-top-color: var(--accent-color, #3b7ad1);
      animation: chord-spin 0.8s linear infinite;
    }
  }
}

/* spinner keyframes */
@keyframes chord-spin {
  to { transform: rotate(360deg); }
}

/* === Subtle loading state for disabled controls (optional, không đổi layout) === */
.editor-controls select:disabled,
.editor-footer .btn-primary:disabled,
.editor-footer .btn-secondary:disabled {
  opacity: 0.65;
  filter: saturate(80%);
  cursor: not-allowed;
}

/* Khi loading, làm mờ nhẹ toàn bộ card nhưng vẫn tương tác được với các khu vực không disabled */
.editor-controls.card[aria-busy="true"] {
  position: relative;
}

.editor-controls.card[aria-busy="true"]::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(
    90deg,
    transparent 0%,
    color-mix(in srgb, var(--card-background) 60%, var(--text-color) 4%) 50%,
    transparent 100%
  );
  opacity: 0.35;
  pointer-events: none;
  animation: chord-sheen 1.2s ease-in-out infinite;
  mix-blend-mode: normal;
  border-radius: 0.75rem;
}

@keyframes chord-sheen {
  0%   { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
