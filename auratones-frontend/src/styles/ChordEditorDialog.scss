@use "./mixins" as *;

/* ===== PANEL 90vh: header | body | footer ===== */
.panel.chord-panel {
  inline-size: min(90vw, 110rem);
  block-size: 90vh; /* quan trọng */
  display: grid;
  grid-template-rows: auto minmax(0, 1fr) auto; /* header | body | footer */
  padding: 1rem;
  gap: 0.75rem;
}

/* Thẻ có khung (padding nhẹ) */
.card {
  padding: 0.625rem; /* nhẹ nhàng */
  background: var(--card-background);
  border-radius: 0.75rem;
  border: 0.0625rem solid color-mix(in srgb, var(--text-color) 10%, transparent);
}

/* ===== BODY SPLIT: 1/3 info | 2/3 input khi có voicing ===== */
.editor-body {
  min-block-size: 0; /* để con có thể scroll */
  overflow: hidden;
}

/* Grid 2 hàng khi có voicing, 1 hàng khi không */
.editor-split {
  display: grid;
  grid-template-areas: "controls";
  grid-template-rows: minmax(0, 1fr);
  min-block-size: 0;
}
.editor-split.has-voicing {
  grid-template-areas:
    "controls"
    "input";
  grid-template-rows: minmax(0, 1fr) minmax(0, 2fr); /* 1/3 | 2/3 */
  row-gap: 0.75rem;
}

/* ====== INFO (header controls) ====== */
.editor-controls {
  grid-area: controls;
  min-block-size: 0;
  overflow: auto;

  .lbl { font-weight: 700; }
}

/* 2 cột × 2 hàng: B1-B2 trên, B3-B4 dưới */
.editor-controls .ctrl-grid {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 2 cột */
  grid-auto-rows: minmax(min-content, auto);
  gap: 0.75rem;
  width: 100%;
}

/* Block 1: gồm 2 block nhỏ dọc 2 dòng (label | controls) */
.ctrl-block.block-1 {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 2 "blocksmall" song song */
  gap: 0.75rem;
}
.ctrl-block.block-1 .blocksmall {
  display: grid;
  grid-template-rows: auto auto;
  row-gap: 0.375rem;
}
.ctrl-block.block-1 .blocksmall > .lbl {
  justify-self: center;
  text-align: center;
}
.ctrl-block.block-1 .blocksmall > .root-with-slash,
.ctrl-block.block-1 .blocksmall > div {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* Các block còn lại: 1 hàng gọn */
.ctrl-block.block-2,
.ctrl-block.block-3,
.ctrl-block.block-4 {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: nowrap;
}

/* Preview text */
.ctrl-block.block-3 .preview-code {
  display: inline-flex;
  align-items: center;
  padding: 0.375rem 0.625rem;
  border-radius: 0.5rem;
  border: 0.0625rem solid color-mix(in srgb, var(--text-color) 16%, transparent);
  background: color-mix(in srgb, var(--card-background) 96%, var(--background-color) 4%);
  font-weight: 800;
  white-space: nowrap;
  max-inline-size: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Toggle: nhỏ gọn; ON chỉ đổi màu icon */
.toggle {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.25rem 0.5rem;
  border: none;
  background: transparent;
  color: var(--text-color);
  cursor: pointer;
  transition: color 120ms ease, transform 60ms ease;
  line-height: 1;

  svg { display: block; inline-size: 1rem; block-size: 1rem; }
  &:hover { transform: translateY(-0.03125rem); }
  &.is-on { color: var(--accent-color); }
}

/* Select chung trong header */
.editor-controls select {
  @include select-base(1.875rem, 6.5rem, 2rem, 0.75rem);
}

/* (root + / + bass) — bass nhỏ gọn */
.slash-sep { opacity: .7; font-weight: 800; }
.ctrl-block.block-1 .root-with-slash select:last-child {
  @include select-base(1.75rem, 5.5rem, 1.5rem, 0.5rem);
}

/* ====== INPUT (preview + canvas) ====== */
.editor-input {
  grid-area: input;
  min-block-size: 0;
  display: grid;
  grid-template-columns: 1fr 2fr; /* 1/3 | 2/3 */
  gap: 0.75rem;
  overflow: hidden; /* để con control scroll */
}

/* Preview trái */
.editor-preview {
  min-block-size: 0;
  overflow: auto;

  .chord-svg { inline-size: 100%; block-size: auto; display: block; }
}

/* Root select dưới preview */
.root-select {
  margin-top: 0.625rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  label {
    font-weight: 600;
    display: flex; align-items: center; gap: 0.375rem;
  }
  select { @include select-base(1.875rem, 6.5rem, 2rem, 0.75rem); }
}

/* Canvas phải */
.editor-canvas {
  min-block-size: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  overflow: hidden; /* grid + toolbar */
}

/* Lưới editor: cho phép scroll riêng */
.editor-grid {
  --fret-cols: 5;
  --side-col: 8%;
  --finger-col: 12%;
  --cell-min: 3.5rem;
  --cell-h: 2.25rem; /* giảm nhẹ chiều cao ô */

  border-radius: var(--border-radius-md, 0.5rem);
  background: var(--card-background);
  border: 0.0625rem solid color-mix(in srgb, var(--text-color) 10%, transparent);
  padding: 0.5rem;
  overflow-x: auto;
  overflow-y: auto; /* cho phép scroll dọc khi cần */
  min-block-size: 0;

  .row {
    display: grid;
    grid-template-columns:
      minmax(2.5rem, var(--side-col))
      repeat(var(--fret-cols), minmax(var(--cell-min), 1fr))
      minmax(2.5rem, var(--side-col))
      minmax(5rem, var(--finger-col));
    gap: 0.375rem;
    align-items: center;

    &.header {
      font-weight: 800; color: var(--text-color); opacity: 0.9;
      .cell.head, .cell.stub { display: inline-flex; justify-content: center; align-items: center; }
      .finger-head { text-align: center; }
    }
  }

  &.fret-4 {
    --fret-cols: 4; --side-col: 7%; --finger-col: 10%; --cell-min: 5.25rem;
  }

  .cell {
    block-size: var(--cell-h);
    border-radius: 0.5rem;
    border: 0.0625rem dashed color-mix(in srgb, var(--text-color) 18%, transparent);
    background: color-mix(in srgb, var(--card-background) 92%, var(--background-color) 8%);
    color: var(--text-color);
    display: inline-flex; align-items: center; justify-content: center;
    user-select: none; cursor: pointer;
    transition: background 120ms ease, color 120ms ease, border-color 120ms ease, transform 60ms ease;
    font-size: 0.85rem;
    position: relative;

    &:hover {
      background: color-mix(in srgb, var(--accent-color) 9%, transparent);
      color: var(--accent-color, #3b7ad1);
      border-color: color-mix(in srgb, var(--accent-color) 35%, transparent);
    }

    &.on {
      background: var(--accent-color, #3b7ad1);
      color: #fff; border-color: var(--accent-color, #3b7ad1); font-weight: 800;
      box-shadow: 0 0.375rem 1rem color-mix(in srgb, var(--accent-color) 25%, transparent);
    }

    &.barre {
      background: color-mix(in srgb, var(--accent-color) 80%, #000 0%);
      color: #fff; border-color: var(--accent-color, #3b7ad1); font-weight: 900;
    }

    &.side { border-style: solid; font-weight: 800; }
    &.side.mute.active {
      background: rgba(0,0,0,.08); color: var(--danger-color, #f44336);
      border-color: color-mix(in srgb, var(--danger-color, #f44336) 60%, transparent);
    }
    &.side.open.active {
      background: color-mix(in srgb, var(--accent-color) 10%, transparent);
      color: var(--accent-color, #3b7ad1);
      border-color: color-mix(in srgb, var(--accent-color) 45%, transparent);
    }

    &.finger-cell {
      cursor: default; border-style: solid;
      select {
        @include select-base(1.625rem, 5.5rem, 2rem, 0.5rem);
        inline-size: 100%; text-align: center; font-weight: 800;
        &:disabled { opacity: .6; cursor: not-allowed; }
      }
    }
  }

  .cell .finger-badge {
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
    inline-size: 1.125rem; block-size: 1.125rem; margin: auto; border-radius: 50%;
    font-weight: 700; font-size: 0.72rem; line-height: 1;
    background: rgba(0, 0, 0, 0.12); color: inherit;
  }
  .cell.on.has-finger .finger-badge { background: rgba(0, 0, 0, 0.25); color: #fff; }
  .cell.barre .finger-badge { transform: translateY(-0.0625rem); }
}

/* Toolbar dưới grid — làm gọn input/select/±/reset */
.voicing-toolbar {
  display: flex; flex-wrap: wrap; gap: 0.5rem;
  .bf-group {
    display: inline-flex; align-items: center; gap: 0.375rem;
    padding: 0.375rem 0.5rem;
    border-radius: 999rem;
    border: 0.0625rem solid color-mix(in srgb, var(--text-color) 16%, transparent);
    background: color-mix(in srgb, var(--card-background) 94%, var(--background-color) 6%);
  }
  .bf-label { font-weight: 700; margin-inline-end: 0.125rem; }
  .bf-btn {
    inline-size: 1.5rem; block-size: 1.5rem;
    display: inline-grid; place-items: center;
    border-radius: 0.5rem; border: 0.0625rem solid color-mix(in srgb, var(--text-color) 22%, transparent);
    background: var(--card-background); cursor: pointer; user-select: none;
  }
  .bf-value {
    min-inline-size: 2.5rem; block-size: 1.5rem;
    text-align: center; font-weight: 800;
    border: 0.0625rem solid color-mix(in srgb, var(--text-color) 22%, transparent);
    border-radius: 0.5rem; background: var(--card-background); color: var(--text-color);
    padding-inline: 0.375rem;
  }
  select.bf-value { @include select-base(1.5rem, 4.25rem, 1.5rem, 0.375rem); text-align: center; font-weight: 800; }
  .bf-ghost {
    padding: 0.25rem 0.625rem; border-radius: 999rem;
    border: 0.0625rem solid color-mix(in srgb, var(--accent-color) 40%, transparent);
    background: color-mix(in srgb, var(--accent-color) 8%, transparent);
    color: var(--accent-color); font-weight: 700; cursor: pointer;
  }
}

/* Footer */
.editor-footer {
  display: flex; justify-content: space-between; align-items: center; gap: 0.75rem;
  .btn-primary, .btn-secondary { font-size: 0.875rem; line-height: 1.1; display: inline-flex; align-items: center; justify-content: center; }
}
.editor-footer-note { opacity: .78; }

/* Buttons (giữ nguyên) */
.btn-primary {
  padding: 0.5rem 0.875rem; border-radius: 999rem; border: none; cursor: pointer; font-weight: 700;
  background: var(--accent-color, #3b7ad1); color: var(--text-color) !important;
  box-shadow: 0 0.375rem 1.125rem rgba(var(--accent-color-rgb, 59, 122, 209), 0.28);
  transition: transform 120ms ease, box-shadow 120ms ease;
  &:hover { transform: translateY(-0.0625rem); box-shadow: 0 0.625rem 1.375rem rgba(var(--accent-color-rgb, 59, 122, 209), 0.36); }
  &:disabled { opacity: .6; pointer-events: none; color: var(--text-color) !important; }
}
.btn-secondary {
  padding: 0.5rem 0.875rem; border-radius: 999rem;
  border: 0.0625rem solid color-mix(in srgb, var(--text-color) 20%, transparent);
  background: var(--card-background); color: var(--text-color) !important; cursor: pointer; transition: background 120ms ease;
  &:hover { background: color-mix(in srgb, var(--card-background) 92%, var(--background-color) 8%); }
  &:disabled { opacity: .6; pointer-events: none; }
}

/* Responsive tổng thể */
@media (max-width: 60rem) {
  .panel.chord-panel { inline-size: min(100vw, 110rem); }
  .editor-input { grid-template-columns: 1fr; }
}

/* Invalid highlight */
.editor-controls.invalid,
.editor-canvas.invalid {
  outline: 0.125rem solid #f44336;
  outline-offset: 0.25rem;
  border-radius: 0.5rem;
}
.select-invalid { @include control-invalid(); }
